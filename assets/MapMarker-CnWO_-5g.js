import{j as e,v as Qe,d as ee,w as te,x as se,y as Ze,z as ae,e as re,k as h,H as L,m as u,i as l,l as i,J as H,K as x,M as T,O as ne,P as fe}from"./ionic-Bk_P96ZF.js";import{r as n}from"./vendor-NXI3fooF.js";import{s as Xe,h as b,i as je,j as ye,k as be,n as oe}from"./index-BCR8R_7f.js";import{m as g}from"./mapbox-gl-DzlfilDF.js";import{s as Y}from"./supabaseClient-DzfNh-zC.js";import"./supabase-Dfjzly43.js";g.accessToken="pk.eyJ1Ijoib3BvcDI5IiwiYSI6ImNtZm8za3Q1NjAxcTEyanF4ZjZraWowdjEifQ.jNxrXsiX7Davmhjmp4ihWw";const lt=()=>{const q=n.useRef(null),a=n.useRef(null);n.useRef(null);const v=n.useRef([]),[Q,ve]=n.useState("mapbox://styles/mapbox/streets-v11"),[A,ke]=n.useState(!1),[k,Se]=n.useState(!0),[Je,Ke]=n.useState(null),[j,le]=n.useState(!1),[y,E]=n.useState(null),[we,S]=n.useState(!1),[Z,ie]=n.useState(""),[w,X]=n.useState(""),[ce,de]=n.useState("#007cf0"),[m,J]=n.useState([]),[_,Ce]=n.useState([]),[z,Me]=n.useState(!1),[C,Ie]=n.useState("all"),[p,B]=n.useState(""),[De,ue]=n.useState(new Date().toISOString().split("T")[0]),[G,Le]=n.useState(!0),[N,Te]=n.useState(!0),[O,Ae]=n.useState(!0),[P,Ee]=n.useState(!1),[pe,_e]=n.useState([]),[ze,M]=n.useState(!1),[$,he]=n.useState(""),[V,xe]=n.useState("#007cf0"),[I,K]=n.useState([]),[f,U]=n.useState(!1),[Be,Ge]=n.useState([]),[R,Ne]=n.useState({center:[124.8681005804846,8.360074137369724],zoom:16,pitch:0,bearing:0}),Oe=[{label:"Streets",url:"mapbox://styles/mapbox/streets-v11"},{label:"Outdoors",url:"mapbox://styles/mapbox/outdoors-v12"},{label:"Light",url:"mapbox://styles/mapbox/light-v11"},{label:"Dark",url:"mapbox://styles/mapbox/dark-v11"},{label:"Satellite",url:"mapbox://styles/mapbox/satellite-v9"},{label:"Satellite Streets",url:"mapbox://styles/mapbox/satellite-streets-v12"}],ge=()=>{a.current&&(a.current.getSource("mapbox-dem")||(a.current.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),a.current.setTerrain({source:"mapbox-dem",exaggeration:1.5})),a.current.getLayer("3d-buildings")?a.current.setLayoutProperty("3d-buildings","visibility","visible"):a.current.addLayer({id:"3d-buildings",source:"composite","source-layer":"building",filter:["==","extrude","true"],type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":"#aaa","fill-extrusion-height":["get","height"],"fill-extrusion-base":["get","min_height"],"fill-extrusion-opacity":.6}}),a.current.flyTo({pitch:60,bearing:-20,duration:2e3,essential:!0}))},Pe=()=>{a.current&&(a.current.flyTo({pitch:0,bearing:0,duration:2e3,essential:!0}),a.current.getLayer("3d-buildings")&&a.current.setLayoutProperty("3d-buildings","visibility","none"))};n.useEffect(()=>{if(q.current){if(a.current){try{Ne({center:a.current.getCenter().toArray(),zoom:a.current.getZoom(),pitch:a.current.getPitch(),bearing:a.current.getBearing()}),a.current.remove()}catch(t){console.warn("Map cleanup failed:",t)}a.current=null}return a.current=new g.Map({container:q.current,style:Q,center:R.center,zoom:R.zoom,pitch:R.pitch,bearing:R.bearing}),a.current.addControl(new g.NavigationControl,"top-right"),a.current.on("load",()=>{a.current?.resize(),A&&ge(),F(),$e()}),()=>{if(a.current){try{a.current.remove()}catch(t){console.warn("Error while removing map:",t)}a.current=null}}}},[Q]),n.useEffect(()=>{a.current&&(A?ge():Pe())},[A]),n.useEffect(()=>{W()},[C,p,_,G,N,O,P]),n.useEffect(()=>{a.current&&(console.log("Search query changed to:",p),W())},[p]),n.useEffect(()=>{if(!a.current)return;const t=r=>{if(j){const s=r.lngLat.toArray();E(s),S(!0),le(!1)}else if(f){const s=r.lngLat.toArray();K(o=>[...o,{coords:s,index:o.length+1}]),new g.Marker({color:V}).setLngLat([s[0],s[1]]).addTo(a.current)}};return j||f?a.current.on("click",t):a.current.off("click",t),()=>{a.current&&a.current.off("click",t)}},[j,f,V,I]);const F=async()=>{const{data:t,error:r}=await Y.from("ar_pois").select("id, lat, lng, label, mark_type, color, height, dates, group_name, group_index");if(r)console.error("Error loading markers:",r);else{Ce(t||[]),W();const s=new Set;t?.forEach(o=>{o.dates&&Array.isArray(o.dates)&&o.dates.forEach(d=>s.add(d))}),Ge(Array.from(s))}},$e=async()=>{const{data:t,error:r}=await Y.from("mark_types").select("value, label").order("label");r?console.error("Error loading mark types:",r):_e(t||[])},Ve=t=>{if(!t.dates||t.dates.length===0)return!1;const r=new Date().toISOString().split("T")[0];return t.dates.reduce((o,d)=>d>o?d:o,t.dates[0])<r},Re=t=>{const r=new Date().toISOString().split("T")[0];return t>=r},me=t=>{const r=t.filter(s=>!Re(s));return{isValid:r.length===0,invalidDates:r}},D=n.useCallback(()=>_.filter(t=>{const r=C==="all"||t.mark_type.startsWith(C),s=p.toLowerCase().trim(),o=s===""||t.label.toLowerCase().includes(s)||t.mark_type.toLowerCase().includes(s)||t.lat.toString().includes(s)||t.lng.toString().includes(s)||t.group_name&&t.group_name.toLowerCase().includes(s)||t.color&&t.color.toLowerCase().includes(s),d=!!t.group_name,c=t.dates&&t.dates.length>0&&!d,Ye=!t.dates||t.dates.length===0&&!d,qe=Ve(t);return r&&o&&(N&&d||O&&c||G&&Ye)&&(P||!qe)}),[_,C,p,N,O,G,P]),Fe=t=>{if(!a.current)return;v.current.forEach(s=>s.remove()),v.current=[],_.filter(s=>s.dates&&s.dates.includes(t)).forEach(s=>{const o=new g.Popup({offset:25}).setHTML(`<strong>${s.label}</strong><br>Type: ${s.mark_type}<br>Lat: ${s.lat}<br>Lng: ${s.lng}`),d=new g.Marker({color:s.color||"#007cf0"}).setLngLat([s.lng,s.lat]).setPopup(o).addTo(a.current);v.current.push(d)})},W=t=>{if(!a.current)return;v.current.forEach(s=>s.remove()),v.current=[];const r=D();r.length===0&&p.trim()!==""&&console.log("No markers found for search query:",p),r.forEach(s=>{const o=new g.Popup({offset:25}).setHTML(`<strong>${s.label}</strong><br>Type: ${s.mark_type}<br>Lat: ${s.lat}<br>Lng: ${s.lng}${s.group_name?`<br>Group: ${s.group_name} #${s.group_index}`:""}`);let d;if(s.group_index){const c=document.createElement("div");c.style.backgroundColor=s.color||"#007cf0",c.style.width="30px",c.style.height="30px",c.style.borderRadius="50%",c.style.border="2px solid white",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.fontSize="12px",c.style.fontWeight="bold",c.style.color="white",c.textContent=s.group_index.toString(),c.setAttribute("aria-label","Map marker"),d=new g.Marker({element:c}).setLngLat([s.lng,s.lat]).setPopup(o)}else d=new g.Marker({color:s.color||"#007cf0"}).setLngLat([s.lng,s.lat]).setPopup(o);d.addTo(a.current),v.current.push(d)})},We=async()=>{if(!y||!Z||!w){alert("Please fill all fields");return}if(m.length>0){const r=me(m);if(!r.isValid){alert(`Cannot save marker with outdated dates: ${r.invalidDates.join(", ")}. Please select today's date or future dates only.`);return}}const{error:t}=await Y.from("ar_pois").insert({lat:y[1],lng:y[0],label:Z,mark_type:w,color:ce,dates:m});t?console.error("Error saving marker:",t):(S(!1),ie(""),X(""),de("#007cf0"),J([]),E(null),F())},He=async()=>{if(!$||I.length===0){alert("Please enter group name and add markers");return}if(m.length>0){const s=me(m);if(!s.isValid){alert(`Cannot save group with outdated dates: ${s.invalidDates.join(", ")}. Please select today's date or future dates only.`);return}}const t=I.map((s,o)=>({lat:s.coords[1],lng:s.coords[0],label:`${$} ${o+1}`,mark_type:w,color:V,dates:m,group_name:$,group_index:o+1})),{error:r}=await Y.from("ar_pois").insert(t);r?console.error("Error saving group:",r):(M(!1),he(""),xe("#007cf0"),K([]),U(!1),F())};return e.jsxs(Qe,{children:[e.jsx(ee,{children:e.jsxs(te,{children:[e.jsx(se,{slot:"start",children:e.jsx(Ze,{})}),e.jsx(ae,{children:"Map Marker"})]})}),e.jsx(re,{fullscreen:!0,scrollY:!1,children:e.jsxs("div",{className:"map-layout",children:[e.jsxs("div",{className:"map-wrapper",children:[e.jsx("div",{ref:q,className:"map-container"}),e.jsxs("div",{style:{position:"absolute",top:"10px",left:"50%",transform:"translateX(-50%)",zIndex:10,background:"rgba(255,255,255,0.95)",borderRadius:"25px",padding:"8px 15px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",display:"flex",alignItems:"center",gap:"8px",border:"1px solid rgba(0,0,0,0.1)",minWidth:"250px"},children:[e.jsx(h,{icon:Xe,color:"medium"}),e.jsx(L,{value:p,placeholder:"Search markers...",onIonChange:t=>B(t.detail.value),onInput:t=>B(t.target.value),onKeyUp:t=>B(t.target.value),style:{width:"180px","--placeholder-color":"var(--ion-color-medium)","--color":"var(--ion-color-dark)"}}),p&&e.jsx(u,{fill:"clear",size:"small",onClick:()=>B(""),style:{"--padding-start":"4px","--padding-end":"4px"},children:e.jsx(h,{icon:b,color:"medium"})})]})]}),e.jsx(u,{className:"slide-toggle-btn",onClick:()=>Se(!k),fill:"clear",style:{position:"absolute",left:k?"calc(280px + 20px)":"10px",top:"50%",transform:"translateY(-50%)",zIndex:20,background:"linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%)",borderRadius:"50%",width:"50px",height:"50px",boxShadow:"0 4px 16px rgba(33, 150, 243, 0.3)",border:"1px solid rgba(33, 150, 243, 0.1)",transition:"all 0.3s ease-in-out"},children:e.jsx(h,{icon:k?je:ye,color:"primary"})}),e.jsx("div",{className:`options-wrapper ${k?"open":"closed"}`,children:e.jsx("div",{className:"options-card",children:k&&e.jsxs(e.Fragment,{children:[e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"Map Style"}),e.jsx(H,{value:Q,placeholder:"Select Map Layer",onIonChange:t=>ve(t.detail.value),children:Oe.map(t=>e.jsx(x,{value:t.url,children:t.label},t.url))})]}),e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"Enable 3D"}),e.jsx(T,{checked:A,onIonChange:t=>ke(t.detail.checked)})]}),e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"View Type"}),e.jsxs(H,{value:C,placeholder:"Select view type",onIonChange:t=>Ie(t.detail.value),children:[e.jsx(x,{value:"all",children:"View All"}),e.jsx(x,{value:"academic",children:"Academic"}),e.jsx(x,{value:"admin",children:"Administrative"}),e.jsx(x,{value:"student",children:"Student Facilities"}),e.jsx(x,{value:"health",children:"Health & Safety"}),e.jsx(x,{value:"events",children:"Events & Activities"}),e.jsx(x,{value:"transport",children:"Transport & Access"}),e.jsx(x,{value:"services",children:"Services"})]})]}),e.jsxs(u,{expand:"block",onClick:()=>le(!j),children:[e.jsx(h,{icon:j?b:be,slot:"start"}),j?"Cancel Adding Marker":"Add Marker"]}),j&&e.jsx("p",{style:{textAlign:"center",color:"red"},children:"Click on the map to place a marker"}),e.jsxs(u,{expand:"block",onClick:()=>U(!f),children:[e.jsx(h,{icon:f?b:be,slot:"start"}),f?"Cancel Adding Group":"Add Group"]}),f&&e.jsx("p",{style:{textAlign:"center",color:"red"},children:"Click on the map to place group markers"}),f&&I.length>0&&e.jsxs(u,{expand:"block",onClick:()=>M(!0),children:[e.jsx(h,{icon:oe,slot:"start"}),"Finish Group (",I.length," markers)"]}),e.jsxs(u,{expand:"block",onClick:()=>Me(!z),children:[e.jsx(h,{icon:z?je:ye,slot:"start"}),z?"Hide Markers":"View All Markers"]}),e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"View Permanent Marks"}),e.jsx(T,{checked:G,onIonChange:t=>Le(t.detail.checked)})]}),e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"View Group Marks"}),e.jsx(T,{checked:N,onIonChange:t=>Te(t.detail.checked)})]}),e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"View Dated Marks"}),e.jsx(T,{checked:O,onIonChange:t=>Ae(t.detail.checked)})]}),e.jsxs(l,{lines:"none",children:[e.jsx(i,{children:"Show Outdated Marks"}),e.jsx(T,{checked:P,onIonChange:t=>Ee(t.detail.checked)})]}),z&&e.jsxs("div",{className:"markers-list",children:[e.jsxs("div",{style:{padding:"8px 12px",background:"rgba(0,0,0,0.05)",borderRadius:"8px",marginBottom:"8px",fontSize:"12px",color:"var(--ion-color-medium)"},children:[D().length," marker",D().length!==1?"s":""," found",p&&` for "${p}"`]}),D().length===0&&p?e.jsxs("div",{style:{textAlign:"center",padding:"20px",color:"var(--ion-color-medium)",fontSize:"14px"},children:['No markers found for "',p,'"']}):D().map(t=>e.jsxs("div",{className:"marker-item",children:[e.jsx("span",{className:"marker-label",children:t.label}),e.jsx(u,{size:"small",onClick:()=>{a.current&&a.current.flyTo({center:[t.lng,t.lat],zoom:18,duration:2e3,essential:!0})},children:"View"})]},t.id))]})]})})}),e.jsx("div",{className:"button-container",children:e.jsxs("div",{className:"builded-card",children:[e.jsx(ne,{presentation:"date",value:De,onIonChange:t=>{const r=t.detail.value;ue(r),Fe(r)},highlightedDates:Be.map(t=>({date:t,textColor:"#ffffff",backgroundColor:"#000000"}))}),e.jsx("div",{style:{marginBottom:"8px",fontSize:"12px",color:"rgba(255,255,255,0.7)",textAlign:"center"},children:"ðŸ“… Black dates have saved markers"}),e.jsx(u,{expand:"block",color:"danger",onClick:()=>{ue(new Date().toISOString().split("T")[0]),W()},children:"Cancel View"})]})})]})}),e.jsxs(fe,{isOpen:we,onDidDismiss:()=>S(!1),onDidPresent:()=>{setTimeout(()=>{const t=document.querySelector("ion-input input");t&&t.focus()},100)},children:[e.jsx(ee,{children:e.jsxs(te,{children:[e.jsx(ae,{children:"Add Marker"}),e.jsx(se,{slot:"end",children:e.jsx(u,{onClick:()=>S(!1),children:e.jsx(h,{icon:b})})})]})}),e.jsxs(re,{style:{padding:"10px"},children:[e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Label"}),e.jsx(L,{value:Z,onIonChange:t=>ie(t.detail.value),placeholder:"Enter marker label"})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Mark Type"}),e.jsx(H,{value:w,placeholder:"Select mark type",onIonChange:t=>X(t.detail.value),children:pe.map(t=>e.jsx(x,{value:t.value,children:t.label},t.value))})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Color"}),e.jsx("input",{type:"color",value:ce,onChange:t=>de(t.target.value),style:{width:"100%",height:"40px"}})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Latitude"}),e.jsx(L,{type:"number",value:y?y[1].toString():"",onIonChange:t=>{const r=parseFloat(t.detail.value);E(s=>s?[s[0],r]:null)},placeholder:"Latitude"})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Longitude"}),e.jsx(L,{type:"number",value:y?y[0].toString():"",onIonChange:t=>{const r=parseFloat(t.detail.value);E(s=>s?[r,s[1]]:null)},placeholder:"Longitude"})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Dates (Can view past, but only future dates can be saved)"}),e.jsx(ne,{presentation:"date",multiple:!0,value:m,onIonChange:t=>{const r=t.detail.value;J(r)}}),e.jsx("div",{style:{fontSize:"10px",color:"rgba(255,255,255,0.6)",marginTop:"4px"},children:"âš ï¸ You can view past dates, but only today's date and future dates can be saved"})]}),e.jsxs(u,{expand:"full",onClick:We,color:"primary",children:[e.jsx(h,{icon:oe,slot:"start"}),"Done"]}),e.jsxs(u,{expand:"full",onClick:()=>S(!1),color:"danger",children:[e.jsx(h,{icon:b,slot:"start"}),"Cancel"]})]})]}),e.jsxs(fe,{isOpen:ze,onDidDismiss:()=>M(!1),children:[e.jsx(ee,{children:e.jsxs(te,{children:[e.jsx(ae,{children:"Create Group"}),e.jsx(se,{slot:"end",children:e.jsx(u,{onClick:()=>M(!1),children:e.jsx(h,{icon:b})})})]})}),e.jsxs(re,{style:{padding:"10px"},children:[e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Group Name"}),e.jsx(L,{value:$,onIonChange:t=>he(t.detail.value),placeholder:"Enter group name"})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Group Color"}),e.jsx("input",{type:"color",value:V,onChange:t=>xe(t.target.value),style:{width:"100%",height:"40px"}})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Mark Type"}),e.jsx(H,{value:w,placeholder:"Select mark type",onIonChange:t=>X(t.detail.value),children:pe.map(t=>e.jsx(x,{value:t.value,children:t.label},t.value))})]}),e.jsxs(l,{style:{marginBottom:"10px"},children:[e.jsx(i,{position:"stacked",children:"Dates (Can view past, but only future dates can be saved)"}),e.jsx(ne,{presentation:"date",multiple:!0,value:m,onIonChange:t=>{const r=t.detail.value;J(r)}}),e.jsx("div",{style:{fontSize:"10px",color:"rgba(255,255,255,0.6)",marginTop:"4px"},children:"âš ï¸ You can view past dates, but only today's date and future dates can be saved"})]}),e.jsxs(u,{expand:"full",onClick:He,color:"primary",children:[e.jsx(h,{icon:oe,slot:"start"}),"Save Group"]}),e.jsxs(u,{expand:"full",onClick:()=>{M(!1),K([]),U(!1),F()},color:"danger",children:[e.jsx(h,{icon:b,slot:"start"}),"Cancel"]})]})]})]})};export{lt as default};
